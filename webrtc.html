<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drone Control Dashboard</title>

<!-- NippleJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.8.6/nipplejs.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: 'Rajdhani', sans-serif; background: #f5f7fa; }
h1 { text-align: center; margin: 0.4rem 0; }
.telemetry { text-align: center; margin-bottom: 8px; }
.dashboard { display: flex; justify-content: center; align-items: flex-start; gap: 20px; padding: 10px; }

/* LEFT PANEL */
.left-panel { display: flex; flex-direction: column; align-items: center; gap: 10px; }

/* ‚úÖ Perfect black circle containers for joysticks (no oval) */
.joystick-wrapper {
  width: 150px;
  aspect-ratio: 1 / 1;        /* keeps it a perfect circle */
  border-radius: 50%;
  border: 3px solid #333;      /* subtle ring */
  background: #000;            /* black circle as you wanted */
  position: relative;          /* for nipple static positioning */
  overflow: hidden;            /* keep everything inside the circle */
}

/* Small map thumbnail */
.small-map { width: 160px; height: 120px; border: 2px solid #ccc; border-radius: 10px; overflow: hidden; cursor: pointer; }

/* VIDEO (unchanged rectangle stream area) */
.video-section { position: relative; }
#remoteVideo { width: 560px; height: 320px; border-radius: 12px; border: 2px solid #333; background: black; display: block; }

/* Overlay big map */
.overlay-map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; border-radius: 12px; z-index: 5; }
.overlay-map.expanded { display: block; }
#map { width: 100%; height: 100%; }

.right-joystick { display: flex; flex-direction: column; align-items: center; }

#playBtn { margin-top: 12px; padding: 8px 16px; border-radius: 8px; border: none; background: #0d6efd; color: #fff; font-weight: 600; cursor: pointer; }
#playBtn:disabled { opacity: .6; cursor: default; }

.controls { position: fixed; bottom: 18px; right: 18px; display: flex; flex-direction: column; gap: 12px; z-index: 3000; }
.controls button { padding: 10px 16px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
.arm { background: #28a745; color: #fff; }
.takeoff { background: #ffc107; color: #000; }
.rtl { background: #17a2b8; color: #fff; }
.disarm { background: #dc3545; color: #fff; }

/* ‚úÖ NippleJS styling: only the center knob is red; no red outside */
.nipple { background: transparent !important; box-shadow: none !important; }
.nipple .back { border: 0 !important; background: transparent !important; }  /* remove outside red */
.nipple .front {
  background: red !important;              /* red in the middle */
  border: 2px solid #b30000 !important;
  box-shadow: none !important;
}

@media (max-width: 980px) {
  .dashboard { flex-direction: column; align-items: center; }
  #remoteVideo { width: 100%; max-width: 600px; }
  .small-map { width: 120px; height: 90px; }
  .joystick-wrapper { width: 120px; }     /* aspect-ratio keeps circle */
}
</style>
</head>
<body>
<h1>üöÅ Drone Control Dashboard</h1>

<div class="telemetry">
Lat: <span id="lat">--</span> | Lon: <span id="lon">--</span> | Alt: <span id="alt">--</span> m |
Battery: <span id="battery">--</span>% | Status: <span id="status" style="color:#d9534f">Disconnected</span>
</div>

<div class="dashboard">
  <!-- Left panel -->
  <div class="left-panel">
    <div id="mapSmall" class="small-map" title="Click to expand map"></div>
    <div id="leftJoystick" class="joystick-wrapper"></div>
  </div>

  <!-- Center video -->
  <div class="video-section">
    <video id="remoteVideo" autoplay playsinline></video>
    <div id="mapOverlay" class="overlay-map"><div id="map"></div></div>
    <button id="playBtn">‚ñ∂ Play Stream</button>
  </div>

  <!-- Right joystick -->
  <div class="right-joystick">
    <div id="rightJoystick" class="joystick-wrapper"></div>
  </div>
</div>

<div class="controls">
  <button id="arm-btn" class="arm">ARM</button>
  <button id="takeoff-btn" class="takeoff">Takeoff</button>
  <button id="rtl-btn" class="rtl">RTL</button>
  <button id="disarm-btn" class="disarm">Disarm</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAjqWO-x23R9zc91h2ViJJ7NT2VLxpRGcs",
  authDomain: "global-control-d5e7e.firebaseapp.com",
  databaseURL: "https://global-control-d5e7e-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "global-control-d5e7e",
  storageBucket: "global-control-d5e7e.appspot.com",
  messagingSenderId: "272632053642",
  appId: "1:272632053642:web:a6041b94165b47a19f5273",
  measurementId: "G-Y8YS8WTCRH"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Initialize maps
let mapSmall, mapBig, markerSmall, markerBig, mapInitialized = false;

function initMaps() {
  mapSmall = L.map("mapSmall", { attributionControl: false, zoomControl: false }).setView([0,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapSmall);
  markerSmall = L.marker([0,0]).addTo(mapSmall);

  mapBig = L.map("map", { attributionControl: false }).setView([0,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapBig);
  markerBig = L.marker([0,0]).addTo(mapBig);

  mapInitialized = true;
}

// Telemetry listener
function startListening() {
  const telemetryRef = ref(db, "drone/telemetry");
  onValue(telemetryRef, snap => {
    const d = snap.val() || {};
    document.getElementById("lat").textContent = d.latitude ?? "--";
    document.getElementById("lon").textContent = d.longitude ?? "--";
    document.getElementById("alt").textContent = d.altitude ?? "--";
    document.getElementById("battery").textContent = d.battery ?? "--";
    if(d.status) document.getElementById("status").textContent = d.status;
    if(d.latitude && d.longitude && mapInitialized) {
      const loc = [d.latitude, d.longitude];
      markerSmall.setLatLng(loc);
      markerBig.setLatLng(loc);
      mapSmall.setView(loc, 12);
      mapBig.setView(loc, 15);
    }
  });
}

function sendCommand(cmd) {
  push(ref(db,"drone/commands"), {command: cmd, timestamp: Date.now()});
}

document.addEventListener("DOMContentLoaded", ()=>{
  initMaps();
  startListening();

  // Map overlay
  const smallMap = document.getElementById("mapSmall");
  const overlay = document.getElementById("mapOverlay");
  smallMap.addEventListener("click", ()=>{
    overlay.classList.add("expanded");
    setTimeout(()=>mapBig.invalidateSize(),200);
  });
  overlay.addEventListener("click", ()=>overlay.classList.remove("expanded"));

  // ‚úÖ Joysticks centered INSIDE black circles (perfect circles)
  const leftJoy = nipplejs.create({
    zone: document.getElementById("leftJoystick"),
    color: "red",
    size: 110,                               // smaller than 150px container
    mode: "static",
    position: { top: "50%", left: "50%" }    // center inside the circle
  });

  const rightJoy = nipplejs.create({
    zone: document.getElementById("rightJoystick"),
    color: "red",
    size: 110,
    mode: "static",
    position: { top: "50%", left: "50%" }
  });

  // Controls
  document.getElementById("arm-btn").addEventListener("click", ()=>sendCommand("ARM"));
  document.getElementById("takeoff-btn").addEventListener("click", ()=>sendCommand("Takeoff"));
  document.getElementById("rtl-btn").addEventListener("click", ()=>sendCommand("RTL"));
  document.getElementById("disarm-btn").addEventListener("click", ()=>sendCommand("Disarm"));
});
</script>
</body>
</html>
